<?xml version="1.0"?>
<robot name="agvs" xmlns:xacro="http://www.ros.org/wiki/xacro">
    <xacro:include filename="$(find agv_description)/xacro/agv_base.gazebo.xacro" />

    <!-- PROPERTY LIST -->
    <xacro:property name="M_PI" value="3.14159265359"/>
    <xacro:property name="base_length" value="2"/>
    <xacro:property name="base_width" value="4"/>
    <xacro:property name="base_height" value="0.25"/>

    <xacro:property name="wheel_joint_damping" value="0.0" />
    <xacro:property name="wheel_joint_friction" value="0.0" />
    <xacro:property name="wheel_joint_effort_limit" value="10.0" />
    <xacro:property name="wheel_joint_velocity_limit" value="20.0" />
    <xacro:property name="wheel_mechanical_reduction" value="1.0" />

    <xacro:property name="steer_joint_damping" value="0.0" />
    <xacro:property name="steer_joint_friction" value="0.0" />
    <xacro:property name="steer_joint_effort_limit" value="10.0" />
    <xacro:property name="steer_joint_velocity_limit" value="10.0" />
    <xacro:property name="motor_wheel_mechanical_reduction" value="1.0" />

    <!-- Macro for whell -->
    <xacro:macro name="wheel" params="prefix x y z">
        <!--
        <gazebo>
            <static>true</static>
        </gazebo>
        -->
        
        <link name="${prefix}_motor_wheel_link">
            <visual>
                <origin xyz="0 0 0" rpy="0 0 0" />
                <geometry>
                    <mesh filename="package://agv_description/meshes/motor_wheel.dae" scale="1.0 1.0 1.0"/>
                </geometry>
            </visual>

            <gazebo reference="${prefix}_motor_wheel_link">
                <material>Gazebo/Gray</material>
            </gazebo>

            <collision>
                <origin xyz="0 0 0" rpy="0 0 0" /> 
                <geometry>
	                <mesh filename="package://agv_description/meshes/motor_wheel.dae" scale="1.0 1.0 1.0"/>
                    <selfCollide>false</selfCollide>
                </geometry>
            </collision>

            <inertial>
                <mass value="0.5" />
                <origin xyz="0 0 0" />
                <inertia  ixx="1.0" ixy="0.0" ixz="0.0"
                          iyy="1.0" iyz="0.0"  
                          izz="1.0" />
            </inertial>
        </link>

        <joint name="${prefix}_motor_wheel_joint" type="continuous">
            <origin xyz="${x} ${y} ${z}" rpy="0 0 0"/>
            <parent link="base_link"/>
            <child link="${prefix}_motor_wheel_link"/>
            <axis xyz="0 0 1"/>    
            <limit effort="${steer_joint_effort_limit}" 
                   velocity="${steer_joint_velocity_limit}" 
                   lower="-1.5708" upper="1.5708"/>
            <joint_properties damping="${steer_joint_damping}" friction="{steer_joint_friction}"/>
        </joint>

        <transmission name="${prefix}_motor_wheel_trans">
            <type>transmission_interface/SimpleTransmission</type>
            <joint name="${prefix}_motor_wheel_joint">
                <hardwareInterface>hardware_interface/EffortJointInterface</hardwareInterface>
            </joint>
            <actuator name="${prefix}_motor_joint_motor">
                <hardwareInterface>hardware_interface/EffortJointInterface</hardwareInterface>
                <mechanicalReduction>${motor_wheel_mechanical_reduction}</mechanicalReduction>
            </actuator>
        </transmission>

        <link name="${prefix}_wheel_link">
            <visual>
                <origin xyz="0 0 0" rpy="0 0 0" />
                <geometry>
                    <mesh filename="package://agv_description/meshes/agvs_wheel.dae" scale="1.0 1.0 1.0"/>
                </geometry>
	            <material name="red">
	                <color rgba="0.5 0.1 0.1 1"/>
                </material>
            </visual>

            <collision>
                <origin xyz="0 0 0" rpy="0 0 0" /> 
                <geometry>
	                <mesh filename="package://agv_description/meshes/agvs_wheel.dae" scale="1.0 1.0 1.0"/>
                    <selfCollide>false</selfCollide>
                </geometry>
            </collision>

            <inertial>
                <mass value="2.0" />
                <origin xyz="0 0 0" />
                <inertia  ixx="1.0" ixy="0.0" ixz="0.0"  
                          iyy="1.0" iyz="0.0"  
                          izz="1.0" />
            </inertial>
        </link>

        <joint name="${prefix}_wheel_joint" type="continuous">
            <origin xyz="0 0 0" rpy="0 0 0"/>
            <parent link="${prefix}_motor_wheel_link"/>
            <child link="${prefix}_wheel_link"/>
            <axis xyz="0 1 0"/>
            <limit effort="${wheel_joint_effort_limit}" velocity="${wheel_joint_velocity_limit}"/>
            <joint_properties damping="${wheel_joint_damping}" friction="{wheel_joint_friction}"/>
        </joint>
<!--
        <transmission name="${prefix}_wheel_trans">
            <type>transmission_interface/SimpleTransmission</type>
            <joint name="${prefix}_wheel_joint">
	            <hardwareInterface>hardware_interface/VelocityJointInterface</hardwareInterface>     
            </joint>
            <actuator name="${prefix}_wheel_joint_motor">
	            <hardwareInterface>hardware_interface/VelocityJointInterface</hardwareInterface>  
                <mechanicalReduction>${wheel_mechanical_reduction}</mechanicalReduction>
            </actuator>
        </transmission>
-->
    </xacro:macro>

    <!-- Macro for agv_base -->
    <xacro:macro name="agv_base">
        <!--
        <gazebo>
            <static>true</static>
        </gazebo>
        -->
        <!-- base_footprint is a fictitious link(frame) that is on the ground right below base_link 
             origin, navigation stack depends on this frame -->
        <link name="base_footprint">
            <visual>
                <origin xyz="0 0 0" rpy="0 0 0" />
                <geometry>
                    <box size="0.001 0.001 0.001" />
                </geometry>
            </visual>
        </link>

        <joint name="base_joint" type="fixed">
            <origin xyz="0 0 0.394815" rpy="0 0 0" />        
            <parent link="base_footprint"/>
            <child link="base_link" />
        </joint>

        <link name="base_link">
            <visual>
                <origin xyz="0 0 0" rpy="0 0 0" />
                <geometry>
                    <box size="${base_length} ${base_width} ${base_height}"/>
                </geometry>
            </visual>

            <collision>
                <origin xyz="0 0 0" rpy="0 0 0 " />
                <geometry>
                    <box size="${base_length} ${base_width} ${base_height}"/>
                    <selfCollide>false</selfCollide>
                </geometry>
                <surface>
                    <friction>
                        <ode>
                            <kp>1000000.0</kp>
                            <kd>100.0</kd>
                            <mu1>1.5</mu1>
                            <mu2>1.5</mu2>
                        </ode>
                    </friction>
                    <contact>
                        <ode>
                            <min_depth>0.001</min_depth>
                            <kp>1e9</kp>
                        </ode>
                    </contact>
                </surface>
            </collision>
            <inertial>
                <mass value="0.1" />
                <origin xyz="0 0 0" />
                <inertia  ixx="0.0" ixy="0.0" ixz="0.0"  
                          iyy="0.0" iyz="0.0"  
                          izz="0.0" />  
            </inertial>
        </link>

        <gazebo reference="base_link">
            <material>Gazebo/Gray</material>
        </gazebo>

        <wheel prefix="front_right" x=" 0.8"  y=" 1.6" z="-0.285"/>
        <wheel prefix="front_left"  x=" 0.8"  y="-1.6" z="-0.285"/>
        <wheel prefix="back_right"  x="-0.8"  y=" 1.6" z="-0.285"/>
        <wheel prefix="back_left"   x="-0.8"  y="-1.6" z="-0.285"/>

    </xacro:macro>
</robot>
